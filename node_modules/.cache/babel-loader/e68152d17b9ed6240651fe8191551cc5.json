{"ast":null,"code":"import { isArray } from 'util'; //checks if the array is empty\n\nexport function isEmpty(arrayArg) {\n  if (arrayArg === undefined || arrayArg.length == 0) {\n    return true;\n  } else {\n    return false;\n  }\n} //helper function to QuestCreate which makes a new Q structure \n\nexport function makeQ(tGuess, tGuessSd, pThreshold, beta, delta, gamma, grain, dim) {\n  var newQ = {\n    updatePdf: 1,\n    //boolean: 0 for no, 1 for yes\n    warnPdf: 1,\n    //boolean\n    normalizePdf: 1,\n    //boolean. This adds a few ms per call to QuestUpdate, but otherwise the pdf will underflow after about 1000 trials.\n    tGuess: tGuess,\n    tGuessSd: tGuessSd,\n    pThreshold: pThreshold,\n    xThreshold: 0,\n    beta: beta,\n    delta: delta,\n    gamma: gamma,\n    grain: grain,\n    dim: dim,\n    i: [],\n    x: [],\n    x2: [],\n    p2: [],\n    s2: [],\n    //have to make an array of arrays due to lack of multidimensional array support\n    intensity: [],\n    response: [],\n    trialCount: 0,\n    quantileOrder: 0\n  };\n  return newQ;\n} //Creates a new Q structure for QUEST algorithms with parameters: tGuess, tGuessSd, pThreshold, beta, delta, gamma, grain, range\n\nexport function QuestCreate(tGuess, tGuessSd, pThreshold, beta, delta, gamma, grain, range, plotIt) {\n  var nargin = arguments.length;\n  var dim = 0;\n\n  if (nargin > 9 || nargin < 6) {\n    throw new Error(\"Incorrect number of arguments\");\n  }\n\n  if (nargin < 7 || isEmpty(grain)) {\n    grain = 0.01000;\n  }\n\n  if (true) {\n    if (nargin < 8 || isEmpty(range)) {\n      dim = 500;\n    } else {\n      if (range <= 0) {\n        throw new Error(\"Range must be greater than 0\");\n      }\n\n      dim = range / grain;\n      dim = 2 * Math.ceil(dim / 2);\n    }\n  }\n\n  if (nargin < 9 || isEmpty(plotIt)) {\n    plotIt = 0;\n  } // Double check here if there are number errors \n\n\n  if (!isFinite(tGuess) || isNaN(tGuess)) {\n    throw new Error(\"tGuess must be real and finite\");\n  }\n\n  var newQ = makeQ(tGuess, tGuessSd, pThreshold, beta, delta, gamma, grain, dim);\n  newQ = QuestRecompute(newQ, plotIt);\n  return newQ;\n}\nexport function QuestRecompute(q, plotIt) {\n  var math = require('mathjs');\n\n  if (arguments.length < 1) {\n    throw new Error(\"Usage: QuestRecompute( q, plotIt = 0 )\");\n  } //if the struct contains more than one struct as an array then you must set normalizePdf of each to 0. \n\n\n  if (!q.updatePdf) {\n    return;\n  }\n\n  if (q.gamma > q.pThreshold) {\n    console.log(\"Reducing gamma from %.2f to 0.5\");\n    q.gamma = 0.5;\n  }\n\n  if (arguments.length < 2 || isEmpty(plotIt)) {\n    plotIt = 0;\n  }\n\n  q.i = [];\n  q.x = [];\n  q.x2 = [];\n  q.p2 = [];\n  q.s2 = []; //have to make an array of arrays due to lack of multidimensional array support\n\n  for (var i = -q.dim / 2; i <= q.dim / 2; i++) {\n    q.i.push(i);\n  }\n\n  ;\n  q.x = q.i.map(function (x) {\n    return x * q.grain;\n  });\n  var tempA = q.x.map(function (x) {\n    return x / q.tGuessSd;\n  });\n  var tempB = tempA.map(function (x) {\n    return Math.pow(x, 2);\n  });\n  q.pdf = tempB.map(function (x) {\n    return x * -0.5;\n  }).map(function (x) {\n    return Math.exp(x);\n  });\n  ;\n  var sumPDF = sumVector(q.pdf);\n  q.pdf = q.pdf.map(function (x) {\n    return x / sumPDF;\n  });\n  var i2 = [];\n\n  for (i = -q.dim; i <= q.dim; i++) {\n    i2.push(i);\n  }\n\n  q.x2 = i2.map(function (x) {\n    return math.eval(x + \"*\" + q.grain);\n  });\n  tempA = q.x2.map(function (x) {\n    return math.eval(x + \"*\" + q.beta);\n  });\n  q.p2 = tempA.map(function (x) {\n    return math.eval(q.delta + \"*\" + q.gamma + \"+ ( 1 -\" + q.delta + \" ) * ( 1 - ( 1-\" + q.gamma + \") *\" + \"e^(-10 ^ \" + x + \"))\");\n  });\n\n  if (Math.min(q.p2[0], q.p2[q.p2.length - 1]) > q.pThreshold || Math.max(q.p2[0], q.p2[q.p2.length - 1]) < q.pThreshold) {\n    throw new Error('psychometric function range [' + Math.min.apply(null, q.p2) + \" \" + Math.max.apply(null, q.p2) + ' ] omits ' + q.pThreshold + ' threshold');\n  }\n\n  var linear = require('everpolate').linear;\n\n  q.xThreshold = linear(q.pThreshold, q.p2, q.x2);\n\n  for (var i = 0; i < q.p2.length; i++) {\n    if (!isFinite(q.p2[i])) {\n      throw new Error('psychometric function p2 is not finite' + i);\n    }\n  }\n\n  q.p2 = q.x2.map(function (x) {\n    return math.eval(q.delta + \"*\" + q.gamma + \"+ ( 1 -\" + q.delta + \" ) * ( 1 - ( 1-\" + q.gamma + \") *\" + \"e^(-10 ^ (\" + q.beta + \"* (\" + x + \"+\" + q.xThreshold + \"))))\");\n  });\n  var tempC = q.p2.slice();\n  tempC = tempC.reverse();\n  var array1 = tempC.map(function (x) {\n    return 1 - x;\n  });\n  var array2 = tempC;\n  q.s2[0] = array1;\n  q.s2[1] = array2;\n\n  if (q.intensity.length == 0 || q.response.length == 0) {\n    var arrayZero = new Array(10000).fill(0);\n    q.trialCount = 0;\n    q.intensity = arrayZero;\n    q.response = arrayZero;\n  }\n\n  for (var k = 0; k < q.s2.length; k++) {\n    for (i = 0; i < q.s2[k].length; i++) {\n      if (!isFinite(q.s2[k][i])) {\n        throw new Error('psychometric function s2 is not finite' + i);\n      }\n    }\n  }\n\n  var pL = q.p2[0];\n  var pH = q.p2[q.p2.length - 1];\n  var pE = pH * Math.log(pH + Number.EPSILON) - pL * Math.log(pL + Number.EPSILON) + (1 - pH + Number.EPSILON) * Math.log(1 - pH + Number.EPSILON) - (1 - pL + Number.EPSILON) * Math.log(1 - pL + Number.EPSILON);\n  pE = 1 / (1 + Math.exp(pE / (pL - pH)));\n  q.quantileOrder = (pE - pL) / (pH - pL);\n\n  for (var j = 0; j < q.pdf.length; j++) {\n    if (!isFinite(q.pdf[j])) {\n      throw new Error('prior pdf is not finite');\n    }\n  }\n\n  for (k = 0; k < q.trialCount; k++) {\n    var inten = Math.max(-1e10, Math.min(1e10, q.intensity[k]));\n    var ii = q.i.map(function (x) {\n      return q.pdf.length + x - Math.round((inten - q.tGuess) / q.grain);\n    });\n\n    if (ii[0] < 1) {\n      ii = ii.map(function (x) {\n        return x + 1 - ii[0];\n      });\n    }\n\n    if (ii[ii.length - 1] > q.s2[0].length) {\n      ii = ii.map(function (x) {\n        return x + q.s2.length - ii[ii.length - 1];\n      });\n    }\n\n    var h2 = ii.map(function (x) {\n      return q.s2[q.response[k]][x];\n    });\n\n    for (i = 0; i < h2.length; i++) {\n      q.pdf[i] = q.pdf[i] * h2[i];\n    }\n\n    if (q.normalizePdf && k % 100 == 0) {\n      (function () {\n        var sumPDF = sumVector(q.pdf);\n        q.pdf = q.pdf.map(function (x) {\n          return x / sumPDF;\n        }); //avoid underflow; keep the pdf normalized // 3 ms\n      })();\n    }\n  }\n\n  if (q.normalizePdf) {\n    var _sumPDF = sumVector(q.pdf);\n\n    q.pdf = q.pdf.map(function (x) {\n      return x / _sumPDF;\n    }); //avoid underflow; keep the pdf normalized // 3 ms\n  }\n\n  for (i = 0; i < q.pdf.length; i++) {\n    if (!isFinite(q.pdf[i])) {\n      throw new Error('pdf is not finite');\n    }\n  }\n\n  return q;\n}\nexport function QuestUpdate(q, intensity, response) {\n  if (arguments.length != 3) {\n    throw new Error(\"Incorrect number of parameters (3) \");\n  }\n\n  if (q === undefined) {\n    throw new Error(\"q is undefined \");\n  }\n\n  if (!isFinite(intensity) || isNaN(intensity)) {\n    throw new Error(\"Intensity must be real, not complex\");\n  }\n\n  if (response < 0 || response >= q.s2.length) {\n    throw new Error(\"response \" + response + \" is out of range 0 to \" + q.s2.length);\n  }\n\n  if (q.updatePdf == 1) {\n    var inten = Math.max(-1e10, Math.min(1e10, intensity));\n    var ii = q.i.map(function (x) {\n      return q.pdf.length + x - Math.round((inten - q.tGuess) / q.grain);\n    });\n\n    if (ii[0] < 1 || ii[ii.length - 1] > q.s2[0].length) {\n      if (q.warnPdf == 1) {\n        var low = (1 - q.pdf.length - q.i[0]) * q.grain + q.tGuess;\n        var high = (q.s2[0].length - q.pdf.length - q.i[q.i.length - 1]) * q.grain + q.tGuess;\n        alert('QuestUpdate: intensity ' + inten + ' out of range ' + low + ' to ' + high + '. Pdf will be inexact. Suggest that you increase \"range\" in call to QuestCreate.');\n      }\n\n      if (ii[0] < 1) {\n        ii = ii.map(function (x) {\n          return x + 1 - ii[0];\n        });\n      } else {\n        ii = ii.map(function (x) {\n          return x + q.s2[0].length - ii[ii.length - 1];\n        });\n      }\n    }\n\n    for (var i = 0; i < ii.length; i++) {\n      q.pdf[i] = q.pdf[i] * q.s2[response][ii[i] - 1];\n    }\n\n    if (q.normalizePdf) {\n      var sumPDF = sumVector(q.pdf);\n      q.pdf = q.pdf.map(function (x) {\n        return x / sumPDF;\n      }); //avoid underflow; keep the pdf normalized // 3 ms\n    }\n  } //keep a historical record of the trials\n\n\n  q.trialCount += 1;\n\n  if (q.trialCount > q.intensity.length) {\n    // Out of space in preallocated arrays. Reallocate for additional\n    // 10000 trials. We reallocate in large chunks to reduce memory\n    // fragmentation.\n    for (var _i = 0; _i < 10000; _i++) {\n      q.intensity.push(0);\n      q.response.push(0);\n    }\n  }\n\n  for (var _i2 = 0; _i2 < q.trialCount; _i2++) {\n    q.intensity[_i2] = 0.5;\n    q.response[_i2] = response;\n  }\n\n  return q;\n}\nexport function QuestTrials(q, binsize) {\n  if (arguments.length < 1) {\n    throw new Error('Usage: trial=QuestTrials(q,[binsize])');\n  }\n\n  if (arguments.length < 2) {\n    binsize = [];\n  }\n\n  if (isEmpty(binsize) || !isFinite(binsize)) {\n    binsize = 0;\n  }\n\n  if (binsize < 0) {\n    throw new Error('binsize cannot be negative');\n  } // sort\n\n\n  var inIntensity = q.intensity.slice(0, q.trialCount + 1);\n  var inResponse = q.response.slice(0, q.trialCount + 1);\n  var withIndex = [];\n\n  for (var i in inIntensity) {\n    withIndex.push([inIntensity[i], i]);\n  }\n\n  withIndex.sort(function (left, right) {\n    return left[0] < right[0] ? -1 : 1;\n  });\n  var indexes = [];\n  var intensity = [];\n\n  for (var j in withIndex) {\n    intensity.push(withIndex[j][0]);\n    indexes.push(withIndex[j][1]);\n  }\n\n  var response = [];\n\n  for (i = 0; i < indexes.length; i++) {\n    response.push(inResponse[indexes[i]]);\n  } //quantize\n\n\n  if (binsize > 0) {\n    intensity = intensity.map(function (x) {\n      return Math.round(x / binsize) * binsize;\n    });\n  } // compact\n\n\n  j = 0;\n  var trial = {\n    intensity: [],\n    responses: []\n  };\n  trial.intensity.push(intensity[0]);\n\n  for (i = 0; i < 2; i++) {\n    trial.responses[i] = new Array();\n    trial.responses[i].push(0);\n  }\n\n  for (i = 0; i < intensity.length; i++) {\n    if (intensity[i] != trial.intensity[j]) {\n      j += 1;\n      trial.intensity.push(intensity[i]);\n\n      for (i = 0; i < 2; i++) {\n        trial.responses[i].push(0);\n      }\n    }\n\n    trial.responses[response[i]][j] = trial.responses[response[i]][j] + 1;\n  }\n\n  return trial;\n}\nexport function QuestStimulate(q, tTest, tActual, plotIt) {\n  if (arguments.length < 3) {\n    throw new Error('Usage: response=QuestSimulate(q,tTest,tActual[,plotIt])');\n  }\n\n  var linear = require('everpolate').linear;\n\n  var x2min = Math.min(q.x2[0], q.x2[q.x2.length - 1]);\n  var x2max = Math.max(q.x2[0], q.x2[q.x2.length - 1]);\n  var t = Math.min(Math.max(tTest - tActual, x2min), x2max);\n  var response = linear(t, q.x2, q.p2);\n  return response;\n} //t=QuestMean(q)\n//Get the mean threshold estimate.\n\nexport function QuestMean(q) {\n  if (arguments.length != 1) {\n    throw new Error('Usage: t=QuestMean(q)');\n  }\n\n  var sumPDF = sumVector(q.pdf);\n  var tempA = sumVector(multiplyVector(q.pdf, q.x));\n  var t = q.tGuess + tempA / sumPDF; // mean of our pdf\n\n  return t;\n} //[t,p]=QuestMode(q)\n//\"t\" is the mode threshold estimate\n//\"p\" is the value of the (unnormalized) pdf at t.\n\nexport function QuestMode(q) {\n  if (arguments.length != 1) {\n    throw new Error('Usage: t=QuestMode(q)');\n  }\n\n  var iMode = indexOfMax(q.pdf);\n  var t = q.x[iMode] + q.tGuess;\n  return t;\n} //sd=QuestSd(q)\n//Get the sd of the threshold distribution.\n\nexport function QuestSd(q) {\n  if (arguments.length != 1) {\n    throw new Error('Usage: sd=QuestSd(q)');\n  }\n\n  var p = sumVector(q.pdf);\n  var xSquared = q.x.map(function (x) {\n    return Math.pow(x, 2);\n  });\n  var Squared2 = sumVector(multiplyVector(q.pdf, q.x)) / p;\n  ;\n  var sd = Math.sqrt(sumVector(multiplyVector(q.pdf, xSquared)) / p - Math.pow(Squared2, 2));\n  return sd;\n} //p=QuestPdf(q,t)\n// The (possibly unnormalized) probability density of candidate threshold \"t\".\n// q and t may be vectors of the same size, in which case the returned p is a vector of that size.\n\nexport function QuestPdf(q, t) {\n  if (arguments.length != 2) {\n    throw new Error('Usage: p=QuestPdf(q,t)');\n  }\n\n  var i = Math.round((t - q.tGuess) / q.grain) + 1 + q.dim / 2;\n  i = Math.min(q.pdf.length, Math.max(1, i));\n  var p = q.pdf[i - 1];\n  return p;\n} // p=QuestP(q,x)\n// The probability of a correct (or yes) response at intensity x, assuming\n// threshold is at x=0.\n\nexport function QuestP(q, x) {\n  if (!isReal(x)) {\n    throw new Error('x must be real, not complex.');\n  }\n\n  var p;\n  if (x < q.x2[0]) p = q.p2[0];else if (x > q.x2[q.x2.length - 1]) {\n    p = q.p2[q.p2.length - 1];\n  } else {\n    var linear = require('everpolate').linear;\n\n    p = linear(0, q.x2, q.p2)[0];\n  }\n\n  if (!isFinite(p)) {\n    throw new Error('psychometric function ' + p + ' at ' + x);\n  }\n\n  return p;\n} // intensity=QuestQuantile(q,[quantileOrder])\n//  Gets a quantile of the pdf in the struct q. You may specify the desired\n//  quantileOrder, e.g. 0.5 for median, or, making two calls, 0.05 and 0.95\n//  for a 90% confidence interval. If the \"quantileOrder\" argument is not\n//  supplied, then it's taken from the \"q\" struct. QuestCreate uses\n//  QuestRecompute to compute the optimal quantileOrder and saves that in the\n//  \"q\" struct; this quantileOrder yields a quantile  that is the most\n//  informative intensity for the next trial.\n\nexport function QuestQuantile(q, quantileOrder) {\n  if (arguments.length > 2) {\n    throw new Error('Usage: intensity=QuestQuantile(q,[quantileOrder])');\n  }\n\n  if (arguments.length < 2) {\n    quantileOrder = q.quantileOrder;\n  }\n\n  if (quantileOrder > 1 || quantileOrder < 0) {\n    throw new Error('quantileOrder' + quantileOrder + ' is outside range 0 to 1.');\n  }\n\n  var p = cumsum(q.pdf);\n\n  if (!isFinite(p[p.length - 1])) {\n    throw new Error('pdf is not finite');\n  }\n\n  if (p[p.length - 1] == 0) {\n    throw new Error('pdf is all zero');\n  }\n\n  var t;\n\n  if (quantileOrder < p[0]) {\n    t = q.tGuess + q.x[0];\n    return t;\n  }\n\n  if (quantileOrder > p[p.length - 1]) {\n    t = q.tGuess + q.x[q.x.length - 1];\n    return t;\n  }\n\n  var tempP = p.slice();\n  tempP.unshift(-1);\n  var tempA = diff(tempP);\n  var index = findZero(tempA);\n\n  if (index.length < 2) {\n    throw new Error('pdf has only ' + index.length + ' nonzero point(s)');\n  }\n\n  var linear = require('everpolate').linear;\n\n  var temp1 = subarrayIndex(p, index);\n  var temp2 = subarrayIndex(q.x, index);\n  var t = q.tGuess + linear(quantileOrder * p[p.length - 1], temp1, temp2)[0];\n  return t;\n}\nexport function PAL_Gumbel(alpha, beta, gamma, lambda, x, varargin) {\n  var math = require('mathjs');\n\n  if (arguments.length < 5 || arguments.length > 6) {\n    throw new Error(\"Incorrect number of parameters: alpha, beta, gamma, lambda, x, varargin\");\n  }\n\n  if (varargin) {\n    if (varargin === 'Inverse') {\n      if (isArray(x)) {\n        var y = x.map(function (t) {\n          var c = math.eval(\"(\" + t + \"-\" + gamma + \" ) / (1 - \" + gamma + \"-\" + lambda + \") - 1\");\n          c = math.eval(\"-1 * log( -1 * \" + c + \")\");\n          c = math.eval(\"log10( \" + c + \")\");\n          c = math.divide(c, 2);\n          return math.add(alpha, c);\n        });\n      } else {\n        var c = math.eval(\"(\" + x + \"-\" + gamma + \" ) / (1 - \" + gamma + \"-\" + lambda + \") - 1\");\n        c = math.eval(\"-1 * log( -1 * \" + c + \")\");\n        c = math.eval(\"log10( \" + c + \")\");\n        c = math.divide(c, 2);\n        var y = math.add(alpha, c);\n      }\n    }\n\n    if (varargin === 'Derivative') {\n      if (isArray(x)) {\n        var y = x.map(function (x) {\n          return math.eval(\"( 1 - \" + gamma + \" - \" + lambda + \") * e^(-1 * 10^(\" + beta + \"*\" + \"(\" + x + \"-\" + alpha + \"))) * log(10) * 10^( \" + beta + \"*(\" + x + \"-\" + alpha + \"))*\" + beta);\n        });\n      } else {\n        var y = (1 - gamma - lambda) * Math.exp(-1 * Math.pow(10, beta * (x - alpha))) * Math.log(10) * Math.pow(10, beta * (x - alpha)) * beta;\n      }\n    }\n  } else {\n    if (isArray(x)) {\n      var y = x.map(function (t) {\n        return math.eval(gamma + \"+ ( 1 - \" + gamma + \" - \" + lambda + \") * ( 1 - e^(-1 * 10^(\" + beta + \"*\" + \"(\" + t + \"-\" + alpha + \"))))\");\n      });\n    } else {\n      var y = math.eval(gamma + \"+ ( 1 - \" + gamma + \" - \" + lambda + \") * ( 1 - e^(-1 * 10^(\" + beta + \"*\" + \"(\" + x + \"-\" + alpha + \"))))\"); //var y = gamma + (1 - gamma - lambda) * (1 - Math.exp( -1  * Math.pow( 10, (beta *(x - alpha))))); \n    }\n  }\n\n  return y;\n} //HELPER FUNCTIONS\n\nfunction subarrayIndex(arr, indices) {\n  var new_array = [];\n\n  for (var i = 0; i < indices.length; i++) {\n    new_array.push(arr[indices[i]]);\n  }\n\n  return new_array;\n}\n\nfunction findZero(arr) {\n  var new_array = [];\n\n  for (var i = 0; i < arr.length; i++) {\n    if (arr[i] > 0) {\n      new_array.push(i);\n    }\n\n    ;\n  }\n\n  return new_array;\n}\n\nfunction diff(arr) {\n  var new_array = [];\n\n  for (var i = 0; i < arr.length - 1; i++) {\n    new_array.push(arr[i + 1] - arr[i]);\n  }\n\n  return new_array;\n}\n\nexport function cumsum(arr) {\n  var new_array = [];\n  arr.reduce(function (a, b, i) {\n    return new_array[i] = a + b;\n  }, 0);\n  return new_array;\n}\n\nfunction multiplyVector(a, b) {\n  return a.map(function (e, i) {\n    return e * b[i];\n  });\n}\n\nexport function sumVector(v) {\n  return v.reduce(function (a, b) {\n    return a + b;\n  }, 0);\n}\nexport function indexOfMax(arr) {\n  if (arr.length === 0) {\n    return -1;\n  }\n\n  var max = arr[0];\n  var maxIndex = 0;\n\n  for (var i = 1; i < arr.length; i++) {\n    if (arr[i] > max) {\n      maxIndex = i;\n      max = arr[i];\n    }\n  }\n\n  return maxIndex;\n}\n\nfunction isReal(x) {\n  if (!isFinite(x) || isNaN(x)) {\n    return false;\n  } else {\n    return true;\n  }\n}","map":{"version":3,"sources":["C:\\Users\\Alika\\Desktop\\VCH_Smith\\src\\Quest.js"],"names":["isArray","isEmpty","arrayArg","undefined","length","makeQ","tGuess","tGuessSd","pThreshold","beta","delta","gamma","grain","dim","newQ","updatePdf","warnPdf","normalizePdf","xThreshold","i","x","x2","p2","s2","intensity","response","trialCount","quantileOrder","QuestCreate","range","plotIt","nargin","arguments","Error","Math","ceil","isFinite","isNaN","QuestRecompute","q","math","require","console","log","push","map","tempA","tempB","pow","pdf","exp","sumPDF","sumVector","i2","eval","min","max","apply","linear","tempC","slice","reverse","array1","array2","arrayZero","Array","fill","k","pL","pH","pE","Number","EPSILON","j","inten","ii","round","h2","QuestUpdate","low","high","alert","QuestTrials","binsize","inIntensity","inResponse","withIndex","sort","left","right","indexes","trial","responses","QuestStimulate","tTest","tActual","x2min","x2max","t","QuestMean","multiplyVector","QuestMode","iMode","indexOfMax","QuestSd","p","xSquared","Squared2","sd","sqrt","QuestPdf","QuestP","isReal","QuestQuantile","cumsum","tempP","unshift","diff","index","findZero","temp1","subarrayIndex","temp2","PAL_Gumbel","alpha","lambda","varargin","y","c","divide","add","arr","indices","new_array","reduce","a","b","e","v","maxIndex"],"mappings":"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","sourcesContent":["import { isArray } from 'util';\r\n\r\n\r\n//checks if the array is empty\r\nexport function isEmpty( arrayArg ){\r\n    if (arrayArg === undefined || arrayArg.length == 0) {\r\n        return true;\r\n    }\r\n    else{\r\n        return false;\r\n    }\r\n}\r\n\r\n//helper function to QuestCreate which makes a new Q structure \r\nexport function makeQ( tGuess, tGuessSd, pThreshold, beta, delta, gamma, grain, dim ){\r\n    var newQ = {\r\n        updatePdf: 1, //boolean: 0 for no, 1 for yes\r\n        warnPdf: 1,  //boolean\r\n        normalizePdf: 1,  //boolean. This adds a few ms per call to QuestUpdate, but otherwise the pdf will underflow after about 1000 trials.\r\n        tGuess: tGuess,\r\n        tGuessSd: tGuessSd,\r\n        pThreshold: pThreshold,\r\n        xThreshold: 0, \r\n        beta: beta,\r\n        delta: delta,\r\n        gamma: gamma,\r\n        grain: grain,\r\n        dim: dim,\r\n        i: [],\r\n        x: [], \r\n        x2: [],\r\n        p2: [],\r\n        s2: [], //have to make an array of arrays due to lack of multidimensional array support\r\n        intensity: [], \r\n        response: [],\r\n        trialCount: 0,\r\n        quantileOrder: 0, \r\n    };\r\n    return newQ; \r\n}\r\n\r\n//Creates a new Q structure for QUEST algorithms with parameters: tGuess, tGuessSd, pThreshold, beta, delta, gamma, grain, range\r\nexport function QuestCreate( tGuess, tGuessSd, pThreshold, beta, delta, gamma, grain, range, plotIt ){\r\n\r\n    let nargin = arguments.length;\r\n    let dim = 0;\r\n    \r\n    if(nargin > 9 || nargin < 6){\r\n        throw new Error(\"Incorrect number of arguments\");\r\n    }\r\n    if( nargin < 7 || isEmpty( grain ) ){\r\n        grain = 0.01000;\r\n    }\r\n\r\n    if( true ){\r\n        if( nargin < 8 || isEmpty( range ) ){\r\n            dim = 500;\r\n        }\r\n        else{\r\n            if( range <= 0 ){\r\n                throw new Error(\"Range must be greater than 0\");\r\n            }\r\n            dim = range / grain;\r\n            dim = 2 * Math.ceil( dim / 2 );\r\n        }\r\n    }\r\n\r\n    if( nargin < 9 || isEmpty( plotIt )) {\r\n        plotIt = 0;\r\n    }\r\n\r\n    // Double check here if there are number errors \r\n    if( !(isFinite( tGuess )) || (isNaN( tGuess )) ){\r\n        throw new Error( \"tGuess must be real and finite\" );\r\n    }\r\n    \r\n    var newQ = makeQ( tGuess, tGuessSd, pThreshold, beta, delta, gamma, grain, dim );\r\n    newQ = QuestRecompute( newQ, plotIt );\r\n\r\n    return newQ;\r\n}\r\n\r\nexport function QuestRecompute( q, plotIt ) {\r\n\r\n    const math = require('mathjs');\r\n\r\n    if( arguments.length < 1 ){\r\n        throw new Error(\"Usage: QuestRecompute( q, plotIt = 0 )\");\r\n    }\r\n\r\n    //if the struct contains more than one struct as an array then you must set normalizePdf of each to 0. \r\n\r\n    if( !q.updatePdf ){\r\n        return\r\n    }\r\n\r\n    if( q.gamma > q.pThreshold ){\r\n        console.log(\"Reducing gamma from %.2f to 0.5\");\r\n        q.gamma = 0.5; \r\n    }\r\n\r\n    if( arguments.length < 2 || isEmpty( plotIt ) ){\r\n        plotIt = 0; \r\n    }\r\n\r\n    q.i = [];\r\n    q.x = []; \r\n    q.x2 = [];\r\n    q.p2 = [];\r\n    q.s2 = []; //have to make an array of arrays due to lack of multidimensional array support\r\n\r\n\r\n    for(var i = -q.dim/2; i <= q.dim/2; i++){\r\n        q.i.push( i );  \r\n    };\r\n\r\n    q.x = q.i.map( function( x ) { return x * q.grain; });\r\n\r\n    let tempA = q.x.map( function( x ) { return x / q.tGuessSd; });\r\n    let tempB = tempA.map( function ( x ) { return Math.pow( x, 2 ); });\r\n\r\n    q.pdf = (tempB.map( function ( x ) { return x * -0.5; })).map( function ( x ) { return Math.exp( x ); });;\r\n    let sumPDF = sumVector(q.pdf); \r\n    q.pdf = q.pdf.map( function( x ) { return x / sumPDF; });\r\n\r\n\r\n    let i2 = []; \r\n    for( i = -q.dim; i <= q.dim; i++){\r\n        i2.push(i);  \r\n    }\r\n    q.x2 = i2.map( function( x ) {return (math.eval(x + \"*\" + q.grain));}); \r\n\r\n    tempA = q.x2.map( function( x ) { return (math.eval(x + \"*\" + q.beta)); }); \r\n\r\n    q.p2 = tempA.map( function( x ) { \r\n        return ( math.eval( q.delta + \"*\" + q.gamma + \"+ ( 1 -\" + q.delta + \" ) * ( 1 - ( 1-\" + q.gamma +\") *\" + \"e^(-10 ^ \" + x + \"))\"));\r\n    });  \r\n\r\n    if( Math.min(q.p2[0], q.p2[q.p2.length - 1]) > q.pThreshold || Math.max(q.p2[0], q.p2[q.p2.length - 1]) < q.pThreshold){\r\n        throw new Error( 'psychometric function range [' + Math.min.apply( null, q.p2 ) + \" \" +  Math.max.apply( null, q.p2 ) + ' ] omits ' + q.pThreshold + ' threshold');\r\n    }\r\n\r\n    var linear = require('everpolate').linear;\r\n    q.xThreshold= linear( q.pThreshold , q.p2, q.x2);\r\n    \r\n    for(var i = 0; i < q.p2.length; i++){\r\n        if(!isFinite(q.p2[i])){\r\n            throw new Error( 'psychometric function p2 is not finite' + i);\r\n        }\r\n    }\r\n\r\n    q.p2 = q.x2.map( function ( x ){\r\n        return( math.eval( q.delta + \"*\" + q.gamma + \"+ ( 1 -\" + q.delta + \" ) * ( 1 - ( 1-\" + q.gamma +\") *\" + \"e^(-10 ^ (\" + q.beta + \"* (\" + x + \"+\" + q.xThreshold + \"))))\")); \r\n    } );\r\n\r\n\r\n    let tempC = q.p2.slice(); \r\n    tempC = tempC.reverse(); \r\n    let array1 = tempC.map( function( x ) { return 1 - x; }); \r\n    let array2 = tempC; \r\n\r\n    q.s2[0] = array1; \r\n    q.s2[1] = array2; \r\n\r\n    if( q.intensity.length == 0 || q.response.length  == 0 ){\r\n        let arrayZero = new Array(10000).fill(0); \r\n        q.trialCount = 0;\r\n        q.intensity = arrayZero;\r\n        q.response = arrayZero;\r\n    }   \r\n\r\n\r\n    for( var k = 0; k < q.s2.length; k++){\r\n        for( i = 0; i < q.s2[k].length; i++){\r\n            if(!isFinite(q.s2[k][i])){\r\n                throw new Error( 'psychometric function s2 is not finite' + i);\r\n            }\r\n        }\r\n    }     \r\n    \r\n    let pL = q.p2[0];\r\n    let pH = q.p2[q.p2.length - 1];\r\n    let pE = pH * Math.log(pH + Number.EPSILON) - pL * Math.log( pL+Number.EPSILON ) + ( 1 - pH + Number.EPSILON) * Math.log( 1 - pH + Number.EPSILON ) - ( 1 - pL + Number.EPSILON) * Math.log( 1 - pL + Number.EPSILON);\r\n    pE = 1 / (1 + Math.exp( pE / ( pL - pH)));\r\n    q.quantileOrder= ( pE - pL ) / ( pH - pL);\r\n\r\n    for(var j = 0; j < q.pdf.length; j++){\r\n        if(!isFinite(q.pdf[j])){\r\n            throw new Error( 'prior pdf is not finite');\r\n        }\r\n    }\r\n\r\n    for(k = 0; k < q.trialCount; k++){\r\n        var inten = Math.max( -1e10, Math.min( 1e10 , q.intensity[k])); \r\n        var ii = q.i.map( function( x ) { return q.pdf.length + x - Math.round(( inten - q.tGuess ) / q.grain ); } );\r\n        \r\n        if( ii[ 0 ] < 1){\r\n            ii = ii.map( function( x ) { return (x + 1 - ii[ 0 ]) ; }); \r\n        }\r\n\r\n        if( ii[ii.length - 1] > q.s2[0].length ){\r\n            ii = ii.map( function( x ) { return( x + q.s2.length - ii[ii.length - 1] ); } ); \r\n        }\r\n\r\n        let h2 = ii.map( function( x ) { return( q.s2[q.response[k]][x] ); });\r\n\r\n        for(i = 0; i < h2.length; i++){\r\n            q.pdf[i] = q.pdf[i] * h2[i];\r\n        }\r\n\r\n\t\tif( q.normalizePdf && k % 100 == 0){\r\n            let sumPDF = sumVector(q.pdf); \r\n            q.pdf = q.pdf.map( function( x ) { return x / sumPDF; }); //avoid underflow; keep the pdf normalized // 3 ms\r\n        }\r\n    }\r\n    \r\n\r\n    if( q.normalizePdf ){\r\n        let sumPDF = sumVector( q.pdf ); \r\n        q.pdf = q.pdf.map( function( x ) { return x / sumPDF; }); //avoid underflow; keep the pdf normalized // 3 ms\r\n    }\r\n\r\n    for(i = 0; i < q.pdf.length; i++){\r\n        if(!isFinite(q.pdf[i])){\r\n            throw new Error( 'pdf is not finite');\r\n        }\r\n    }\r\n\r\n    return q; \r\n}\r\n\r\nexport function QuestUpdate( q, intensity, response ) {\r\n\r\n\r\n    if( arguments.length != 3){\r\n        throw new Error( \"Incorrect number of parameters (3) \");\r\n    }\r\n\r\n    if( q === undefined ){\r\n        throw new Error( \"q is undefined \" );\r\n    }\r\n\r\n    if( !(isFinite( intensity )) || (isNaN( intensity )) ){\r\n        throw new Error( \"Intensity must be real, not complex\" );\r\n    }   \r\n\r\n    if( response < 0 || response >= q.s2.length){\r\n        throw new Error( \"response \" + response + \" is out of range 0 to \" + q.s2.length);\r\n    }\r\n\r\n    if( q.updatePdf == 1 ){\r\n\r\n        var inten = Math.max( -1e10, Math.min( 1e10 , intensity)); \r\n        var ii = q.i.map( function( x ) { return q.pdf.length + x - Math.round(( inten - q.tGuess ) / q.grain ); } );\r\n\r\n        if( ii[ 0 ] < 1 || ii[ii.length - 1] > q.s2[0].length ){\r\n            if( q.warnPdf == 1 ){\r\n                let low= ( 1 - q.pdf.length - q.i[0] ) * q.grain + q.tGuess;\r\n                let high=( q.s2[0].length - q.pdf.length - q.i[q.i.length - 1] ) * q.grain + q.tGuess;\r\n                alert('QuestUpdate: intensity ' + inten + ' out of range ' + low + ' to ' + high + '. Pdf will be inexact. Suggest that you increase \"range\" in call to QuestCreate.');\r\n            }\r\n\r\n            if( ii[ 0 ] < 1){\r\n                ii = ii.map( function( x ) { return (x + 1 - ii[ 0 ]) ; }); \r\n            }\r\n\r\n            else {\r\n                ii = ii.map( function( x ) { return (x + q.s2[0].length - ii[ ii.length - 1]) ; }); \r\n            }\r\n        }\r\n        \r\n\r\n        for(let i = 0; i < ii.length; i++){\r\n            q.pdf[i] = q.pdf[i] * q.s2[response][ii[i] - 1];\r\n        }\r\n\r\n        if( q.normalizePdf ){\r\n            let sumPDF = sumVector(q.pdf); \r\n            q.pdf = q.pdf.map( function( x ) { return x / sumPDF; }); //avoid underflow; keep the pdf normalized // 3 ms\r\n        }\r\n    }\r\n\r\n    //keep a historical record of the trials\r\n    q.trialCount += 1;\r\n\r\n    if(q.trialCount > q.intensity.length){\r\n        // Out of space in preallocated arrays. Reallocate for additional\r\n        // 10000 trials. We reallocate in large chunks to reduce memory\r\n        // fragmentation.\r\n\r\n        for(let i = 0; i < 10000; i++){\r\n        q.intensity.push(0);\r\n        q.response.push(0);\r\n        }\r\n    }\r\n\r\n    for( let i = 0; i < q.trialCount; i++){\r\n\r\n        q.intensity[i] = 0.5; \r\n        q.response[i] = response; \r\n    }\r\n\r\n    return q; \r\n}\r\n\r\nexport function QuestTrials(q, binsize){\r\n    if( arguments.length < 1 ){\r\n        throw new Error('Usage: trial=QuestTrials(q,[binsize])');\r\n    }\r\n\r\n    if( arguments.length < 2 ){\r\n        binsize = []; \r\n    }\r\n\r\n    if( isEmpty( binsize ) || !isFinite( binsize )){\r\n        binsize = 0; \r\n    }\r\n\r\n    if( binsize < 0 ){\r\n        throw new Error('binsize cannot be negative');\r\n    }\r\n    \r\n    // sort\r\n    var inIntensity = q.intensity.slice(0, q.trialCount + 1);\r\n    var inResponse = q.response.slice(0, q.trialCount + 1);\r\n\r\n    var withIndex = [];\r\n    for (var i in inIntensity) {\r\n        withIndex.push([inIntensity[i], i]);\r\n    }\r\n    withIndex.sort(function(left, right) {\r\n        return left[0] < right[0] ? -1 : 1;\r\n        });\r\n\r\n    var indexes = [];\r\n    var intensity = [];\r\n\r\n    for (var j in withIndex) {\r\n        intensity.push(withIndex[j][0]);\r\n        indexes.push(withIndex[j][1]);\r\n    }\r\n\r\n    var response = []; \r\n\r\n    for(i = 0; i < indexes.length; i++){\r\n        response.push(inResponse[indexes[i]]);\r\n    }\r\n\r\n    //quantize\r\n    if( binsize > 0){\r\n        intensity = intensity.map(function(x) { return(Math.round( x / binsize ) * binsize); }); \r\n    }\r\n\r\n    // compact\r\n    j = 0;\r\n\r\n    var trial = {\r\n        intensity: [],\r\n        responses: [], \r\n    }\r\n\r\n    trial.intensity.push(intensity[0]); \r\n\r\n    for(i = 0; i < 2; i++){\r\n        trial.responses[i] = new Array(); \r\n        trial.responses[i].push(0); \r\n    }\r\n\r\n    for( i = 0; i < intensity.length; i++){\r\n        if(intensity[i] != trial.intensity[j]){\r\n            j += 1;\r\n            trial.intensity.push(intensity[i]);\r\n            for(i = 0; i < 2; i++){\r\n                trial.responses[i].push(0); \r\n            }\r\n        }\r\n        trial.responses[response[i]][j] = trial.responses[response[i]][j] + 1;\r\n    }\r\n\r\n    return trial; \r\n}\r\n\r\n\r\nexport function QuestStimulate(q, tTest, tActual, plotIt){\r\n    if( arguments.length < 3 ){\r\n        throw new Error('Usage: response=QuestSimulate(q,tTest,tActual[,plotIt])');\r\n    }\r\n\r\n    var linear = require('everpolate').linear\r\n\r\n    var x2min = Math.min(q.x2[0], q.x2[q.x2.length-1]);\r\n    var x2max = Math.max(q.x2[0], q.x2[q.x2.length-1]);\r\n    var t= Math.min(Math.max((tTest - tActual), x2min) , x2max);\r\n    var response = linear(t, q.x2, q.p2);\r\n\r\n    return response; \r\n}\r\n\r\n//t=QuestMean(q)\r\n//Get the mean threshold estimate.\r\n\r\nexport function QuestMean( q ){\r\n    if( arguments.length != 1 ){\r\n        throw new Error('Usage: t=QuestMean(q)');\r\n    }\r\n\r\n    let sumPDF = sumVector( q.pdf ); \r\n\r\n    let tempA = sumVector(multiplyVector(q.pdf, q.x)); \r\n\r\n    var t = q.tGuess + tempA / sumPDF;\t// mean of our pdf\r\n\r\n    return t; \r\n}\r\n\r\n//[t,p]=QuestMode(q)\r\n//\"t\" is the mode threshold estimate\r\n//\"p\" is the value of the (unnormalized) pdf at t.\r\nexport function QuestMode( q ){\r\n    if( arguments.length != 1 ){\r\n        throw new Error('Usage: t=QuestMode(q)');\r\n    }\r\n\r\n    let iMode = indexOfMax(q.pdf);\r\n    var t = q.x[iMode] + q.tGuess;\r\n    return t; \r\n}\r\n\r\n\r\n//sd=QuestSd(q)\r\n//Get the sd of the threshold distribution.\r\n\r\nexport function QuestSd( q ){\r\n    if( arguments.length != 1 ){\r\n        throw new Error('Usage: sd=QuestSd(q)');\r\n    }\r\n    let p = sumVector( q.pdf );\r\n    \r\n    var xSquared = q.x.map(function(x){return Math.pow(x, 2); }); \r\n    var Squared2 = sumVector( multiplyVector(q.pdf, q.x)) / p; ;\r\n\r\n    var sd = Math.sqrt( (sumVector(multiplyVector(q.pdf, xSquared)) / p) - Math.pow(Squared2, 2)) ; \r\n    return sd; \r\n}\r\n//p=QuestPdf(q,t)\r\n// The (possibly unnormalized) probability density of candidate threshold \"t\".\r\n// q and t may be vectors of the same size, in which case the returned p is a vector of that size.\r\nexport function QuestPdf( q, t ){\r\n    if( arguments.length != 2 ){\r\n        throw new Error('Usage: p=QuestPdf(q,t)');\r\n    }\r\n\r\n    var i= Math.round( ( t- q.tGuess ) / q.grain ) + 1 + q.dim / 2;\r\n    i = Math.min( q.pdf.length , Math.max( 1 , i ));\r\n    var p = q.pdf[i - 1];\r\n    return p; \r\n}\r\n\r\n// p=QuestP(q,x)\r\n// The probability of a correct (or yes) response at intensity x, assuming\r\n// threshold is at x=0.\r\nexport function QuestP( q, x ){\r\n\r\n    if( !isReal( x ) ){\r\n        throw new Error('x must be real, not complex.');\r\n    }\r\n\r\n    var p; \r\n    \r\n\r\n    if( x < q.x2[0] )\r\n        p = q.p2[0];\r\n    \r\n    else if( x > q.x2[q.x2.length-1] ){\r\n        p = q.p2[q.p2.length-1]; \r\n    }\r\n\r\n    else{\r\n        var linear = require('everpolate').linear\r\n        p = linear(0, q.x2, q.p2)[0];\r\n    }\r\n\r\n    if( !isFinite(p) ){\r\n        throw new Error('psychometric function ' + p + ' at ' + x);\r\n    }\r\n\r\n    return p; \r\n    \r\n\r\n}\r\n\r\n// intensity=QuestQuantile(q,[quantileOrder])\r\n//  Gets a quantile of the pdf in the struct q. You may specify the desired\r\n//  quantileOrder, e.g. 0.5 for median, or, making two calls, 0.05 and 0.95\r\n//  for a 90% confidence interval. If the \"quantileOrder\" argument is not\r\n//  supplied, then it's taken from the \"q\" struct. QuestCreate uses\r\n//  QuestRecompute to compute the optimal quantileOrder and saves that in the\r\n//  \"q\" struct; this quantileOrder yields a quantile  that is the most\r\n//  informative intensity for the next trial.\r\n\r\nexport function QuestQuantile( q, quantileOrder ){\r\n\r\n    if( arguments.length > 2 ){\r\n        throw new Error('Usage: intensity=QuestQuantile(q,[quantileOrder])');\r\n    }\r\n\r\n    if( arguments.length < 2 ){\r\n        quantileOrder = q.quantileOrder;\r\n    }\r\n\r\n    if( quantileOrder > 1 || quantileOrder < 0 ) {\r\n        throw new Error('quantileOrder' + quantileOrder + ' is outside range 0 to 1.');\r\n    }\r\n\r\n    var p = cumsum( q.pdf );\r\n\r\n    if( !isFinite ( p[p.length - 1] )) {\r\n        throw new Error('pdf is not finite');\r\n    }\r\n\r\n    if( p[p.length - 1] == 0) {\r\n        throw new Error('pdf is all zero');\r\n    }\r\n\r\n    var t; \r\n\r\n    if( quantileOrder < p[0] ){\r\n        t = q.tGuess + q.x[0];\r\n        return t;\r\n    }\r\n\r\n    if( quantileOrder > p[ p.length - 1] ){\r\n        t = q.tGuess + q.x[ q.x.length - 1];\r\n        return t;\r\n    }\r\n\r\n    var tempP = p.slice(); \r\n    \r\n    tempP.unshift(-1);\r\n\r\n    let tempA = diff( tempP );\r\n    var index = findZero( tempA );\r\n\r\n    \r\n\r\n    if( index.length < 2){\r\n\t    throw new Error('pdf has only ' + index.length + ' nonzero point(s)');\r\n    }\r\n\r\n    var linear = require('everpolate').linear\r\n\r\n    var temp1 = subarrayIndex(p, index);\r\n    var temp2 = subarrayIndex(q.x, index);\r\n\r\n    var t  = q.tGuess + (linear(quantileOrder * p[ p.length - 1 ], temp1, temp2)[0]);\r\n    return t; \r\n}\r\n\r\nexport function PAL_Gumbel(alpha, beta, gamma, lambda, x, varargin){\r\n\r\n    const math = require('mathjs');\r\n\r\n    if ( arguments.length < 5 || arguments.length > 6){\r\n        throw new Error(\"Incorrect number of parameters: alpha, beta, gamma, lambda, x, varargin\");\r\n    }\r\n\r\n    if(  varargin ){\r\n        if( varargin === 'Inverse' ){\r\n            if ( isArray(x)){\r\n                var y = x.map(function(t){\r\n                    var c = math.eval( \"(\" + t + \"-\" + gamma + \" ) / (1 - \" + gamma + \"-\" + lambda + \") - 1\");\r\n                    c = math.eval(\"-1 * log( -1 * \" + c + \")\");\r\n                    c = math.eval( \"log10( \" + c + \")\");\r\n                    c = math.divide(c, 2);\r\n                    return math.add(alpha, c); \r\n                })\r\n                \r\n            }\r\n            else{\r\n                var c = math.eval( \"(\" + x + \"-\" + gamma + \" ) / (1 - \" + gamma + \"-\" + lambda + \") - 1\");\r\n                c = math.eval(\"-1 * log( -1 * \" + c + \")\");\r\n                c = math.eval( \"log10( \" + c + \")\");\r\n                c = math.divide(c, 2);\r\n                var y = math.add(alpha, c); \r\n            }\r\n        }\r\n        if( varargin === 'Derivative' ){\r\n            if( isArray( x )){\r\n                var y = x.map(function(x){\r\n                    return math.eval(\"( 1 - \" + gamma + \" - \" + lambda + \") * e^(-1 * 10^(\" + beta + \"*\" + \"(\" + x + \"-\" + alpha + \"))) * log(10) * 10^( \" + beta + \"*(\" + x + \"-\" + alpha + \"))*\" + beta); \r\n                })\r\n            }\r\n            else{\r\n                var y = (1 - gamma - lambda) * Math.exp( -1  * Math.pow( 10, (beta *(x - alpha)))) * Math.log(10) * Math.pow(10, (beta *( x - alpha))) * beta;\r\n            }\r\n        }\r\n    }\r\n    \r\n    else{\r\n        if( isArray( x )){\r\n            var y = x.map(function(t){\r\n                return math.eval(gamma + \"+ ( 1 - \" + gamma + \" - \" + lambda + \") * ( 1 - e^(-1 * 10^(\" + beta + \"*\" + \"(\" + t + \"-\" + alpha + \"))))\"); \r\n            })\r\n        }\r\n        else{\r\n            var y = math.eval(gamma + \"+ ( 1 - \" + gamma + \" - \" + lambda + \") * ( 1 - e^(-1 * 10^(\" + beta + \"*\" + \"(\" + x + \"-\" + alpha + \"))))\"); \r\n            //var y = gamma + (1 - gamma - lambda) * (1 - Math.exp( -1  * Math.pow( 10, (beta *(x - alpha))))); \r\n        }\r\n    }\r\n\r\n    return y;\r\n    \r\n}\r\n\r\n//HELPER FUNCTIONS\r\n\r\nfunction subarrayIndex( arr, indices ){\r\n    var new_array = []\r\n\r\n    for( var i = 0; i < indices.length; i++){\r\n        new_array.push( arr[indices[i]] );\r\n    }\r\n\r\n    return new_array; \r\n}\r\n\r\nfunction findZero ( arr ){\r\n    var new_array = []\r\n\r\n    for(var i = 0; i < arr.length; i++ ){\r\n        if( arr[i] > 0 ){\r\n            new_array.push(i);\r\n        };\r\n    }\r\n\r\n    return new_array; \r\n}\r\n\r\nfunction diff( arr ){\r\n    var new_array = []\r\n\r\n    for(var i = 0; i < arr.length - 1; i++ ){\r\n        new_array.push( arr[ i + 1 ] - arr[ i ] );\r\n    }\r\n\r\n    return new_array; \r\n}\r\n\r\nexport function cumsum( arr ){\r\n    var new_array = []; \r\n    arr.reduce(function(a,b,i) { return new_array[i] = a+b; }, 0);\r\n    return new_array; \r\n}\r\n\r\n\r\nfunction multiplyVector(a,b){\r\n    return a.map((e,i) => e * b[i]);\r\n}\r\n\r\nexport function sumVector(v){\r\n    return v.reduce(( a, b ) => a + b, 0);\r\n}\r\n\r\nexport function indexOfMax(arr) {\r\n    if (arr.length === 0) {\r\n        return -1;\r\n    }\r\n\r\n    var max = arr[0];\r\n    var maxIndex = 0;\r\n\r\n    for (var i = 1; i < arr.length; i++) {\r\n        if (arr[i] > max) {\r\n            maxIndex = i;\r\n            max = arr[i];\r\n        }\r\n    }\r\n\r\n    return maxIndex;\r\n}\r\n\r\nfunction isReal( x ){\r\n    if( !(isFinite( x )) || (isNaN( x )) ){\r\n        return false;\r\n    }\r\n    else{ return true; }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}